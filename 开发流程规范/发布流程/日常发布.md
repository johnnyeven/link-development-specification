# 日常发布
## 目的

为了规范软件产品的版本发布过程，提高软件发布的可控性。

## 版本号

版本号分为四段 **A.B.C.D**，每段为阿拉伯数字，从0开始计数

    1.12.3.1

* “A”为大版本号，系统有体制性的更新的时候+1，例如 Windows8=>Windows10
* “B”为小版本号，小版本号为每次迭代更新时候+1
* “C”为紧急任务发布版本号，紧急任务版本一般是在某次小版本号中进行更新
* “D“为紧急问题发布版本号，紧急问题版本一般是在某次小版本号中进行修改，这些版本都是为了修复一些不能等到下一个小版本或者大版本的问题而生成

## 数据库迁移

* 命名规范

    * 数据库结构发生变更：**structure_{system}_{version}.sql**
    * 数据实体发生变更：**migration_{system}_{version}.sql**

        >       System：系统名称
        >       Version：发布版本号

* 内容规范
    * 每个 SQL 文件内容顶部应包含该文件的功能说明

    ```
    /**
     *@This is description. 
     */
    ```

    * 功能性语句
    
        >       1. 每个文件都必须同时包含功能性语句头部和尾部，头部位于文件说明之后，尾部位于文件末尾
        >       2. SET NAMES utf8：避免中文输入出现乱码
        >       3. UNIQUE_CHECKS：对于数据修复时暂时关闭唯一索引检查，避免修复失败
        >       4. FOREIGN_KEY_CHECKS：对于数据修复时暂时关闭外键检查，避免修复失败
        >       5. SQL_NOTES：对于手动执行数据库语句时，关闭 SQL 日志，提高执行效率，降低 IO 消耗
    
        * 头部
        
        ```
        /*!40101 SET NAMES utf8 */;
        /*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
        /*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
        /*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
        /*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
        ```
        
        * 尾部
        
        ```
        /*!40101 SET SQL_NOTES=@OLD_SQL_NOTES */;
        /*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
        /*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
        ```
    
    * 语句实体

        >       1. 每个语句实体之前必须有该语句完成功能说明
        >       2. 对于数据结构变更 SQL 必须包含每个字段说明
        >       3. 对于数据实体变更 SQL 必须包含事物（BEGIN; 变更实体; COMMIT;），若变更时需要进行锁表需要包含（LOCK TABLES `tablename` WRITE; 变更实体; UNLOCK TABLES;）     
    
* 独立程序脚本

    >       1. 对于特殊需要运行的脚本，需要进行代码评审
    >       2. 脚本执行完成后，需要输出关键性信息（脚本执行时间，受影响条目数，成功条目数，失败条目数，失败原因）

* 回滚脚本

    >       1. 若发布版本中包含数据库迁移，则必须有对应的回滚脚本，文件格式与内容要求与迁移脚本一致
    >       2. 对于不可逻辑回滚的数据，在执行迁移脚本之前需要进行数据备份，回滚时还原备份数据
    
## 配置文件

配置文件新增或变更于代码封版时，由各组Leader整理提供，需要检查以下项目

> 所有配置文件语法检查
> 配置内容正确无误
> 若配置文件结构由变更，需核实结构变更的目的，以及对应的业务处理代码是否正确

## 服务器配置变更

主要涉及需要运维配合进行服务器的配置变更项，包括但不限于以下配置

> nginx服务器配置
> PHP配置
> supervisor配置
> memcached配置
> RDS配置
> 其他基础服务配置

## 上线申请

测试 Leader 在以下几项均满足的情况，可以提交上线申请并进行上线操作：

>  一般情况下回滚版本为上一日常发布版本，若有特殊情况请与开发 Leader 进行协商

>       1. 功能性测试
>       2. 性能测试（若需要）
>       3. 数据库迁移脚本测试（若需要）
>       4. 配置文件测试（若需要）
>       5. 版本生成 

## 上线测试

上线完成后，测试 Leader 需要安排相关测试人员进行**冒烟测试**，特别侧重当前版本功能以及相关功能

## 信息归档

每次上线成功之后需要对此次上线相关资料进行**归档**

